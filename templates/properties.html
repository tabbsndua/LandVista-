{% extends "base.html" %}

{% block title %}Properties | LandVista{% endblock %}
{% block meta_description %}Browse verified land listings across Kenya. Filter by location, status, and budget to find investment-ready properties on LandVista.{% endblock %}
{% block meta_keywords %}properties kenya, plots for sale kenya, land listings kenya, investment plots{% endblock %}
{% block body_class %}properties-modern-body{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/properties-modern.css') }}">
{% endblock %}

{% block content %}
<div class="properties-modern-page">
    <section class="properties-modern-hero">
        <div class="properties-modern-hero-inner">
            <p class="hero-kicker">Verified Listings</p>
            <h1>Browse investment-ready land opportunities.</h1>
            <p>Filter by location, budget, type, and availability to find your ideal property faster.</p>
            <div class="hero-stats">
                <article>
                    <strong>{{ properties|length }}</strong>
                    <span>Total listings</span>
                </article>
                <article>
                    <strong>{{ properties|selectattr("status", "equalto", "sold")|list|length }}</strong>
                    <span>Sold listings</span>
                </article>
                <article>
                    <strong>{{ properties|rejectattr("status", "equalto", "sold")|list|length }}</strong>
                    <span>Available listings</span>
                </article>
            </div>
        </div>
    </section>

    <section class="properties-toolbar-section" data-reveal>
        <div class="properties-toolbar">
            <label class="toolbar-field toolbar-search">
                <span>Search</span>
                <input type="search" id="locationFilter" placeholder="Location or property title">
            </label>

            <label class="toolbar-field">
                <span>Status</span>
                <select id="availabilityFilter">
                    <option value="available">Available</option>
                    <option value="sold">Sold</option>
                    <option value="all">All</option>
                </select>
            </label>

            <label class="toolbar-field">
                <span>Price Range</span>
                <select id="priceFilter">
                    <option value="">Any Price</option>
                    <option value="0-500000">KSh 0 - 500K</option>
                    <option value="500000-1000000">KSh 500K - 1M</option>
                    <option value="1000000-5000000">KSh 1M - 5M</option>
                    <option value="5000000+">KSh 5M+</option>
                </select>
            </label>

            <label class="toolbar-field">
                <span>Sort</span>
                <select id="sortFilter">
                    <option value="latest">Latest</option>
                    <option value="price_low_high">Price: Low to High</option>
                    <option value="price_high_low">Price: High to Low</option>
                    <option value="title_az">Title: A to Z</option>
                </select>
            </label>

            <label class="toolbar-field toolbar-range">
                <span>Max Budget</span>
                <input type="range" id="maxBudgetRange" min="500000" max="10000000" step="100000" value="10000000">
                <small id="maxBudgetValue">Any budget</small>
            </label>

            <div class="toolbar-actions">
                <button class="toolbar-btn primary" id="applyFiltersBtn" type="button">Apply</button>
                <button class="toolbar-btn ghost" id="resetFiltersBtn" type="button">Reset</button>
            </div>
        </div>

        <div class="properties-subtoolbar">
            <div class="filter-chips">
                <button type="button" class="chip active" data-chip-status="available">Available</button>
                <button type="button" class="chip" data-chip-status="sold">Sold</button>
                <button type="button" class="chip" data-chip-status="all">All</button>
            </div>

            <div class="view-toggle">
                <button type="button" class="view-btn active" data-view="grid" aria-label="Grid view"><i class="fas fa-th-large"></i></button>
                <button type="button" class="view-btn" data-view="list" aria-label="List view"><i class="fas fa-list"></i></button>
            </div>
        </div>
    </section>

    <section class="properties-results-section">
        <div class="results-head">
            <p id="resultsCounter">{{ properties|length }} properties</p>
            <p class="results-tip">Tip: Click <strong>Quick View</strong> for a preview modal without leaving this page.</p>
        </div>
        <div id="activeFilterTags" class="active-filter-tags"></div>

        <div id="noResultsMessage" class="no-results" style="display:none;">
            <h3>No properties found</h3>
            <p>Try changing your filter criteria or reset all filters to view every listing.</p>
            <button type="button" id="noResultResetBtn">Reset Filters</button>
        </div>

        <div class="properties-grid grid-view" id="propertiesGrid">
            {% for p in properties %}
            <article class="property-card" data-property-id="{{ p._id }}" data-property-title="{{ p.title }}" data-property-location="{{ p.location }}" data-property-area="{{ p.area }}" data-property-price="{{ p.price }}" data-property-status="{{ p.status or 'available' }}" data-property-description="{{ (p.description or '')|replace('\n', ' ')|e }}">
                <div class="property-media">
                    {% if p.get('media') %}
                        {% if p.media is string %}
                            {% if p.media.endswith(('.mp4', '.webm', '.mov')) %}
                            <video muted preload="metadata" playsinline>
                                <source src="{{ url_for('static', filename='uploads/' ~ p.media) }}">
                            </video>
                            {% else %}
                            <img loading="lazy" src="{{ url_for('static', filename='uploads/' ~ p.media) }}" alt="{{ p.title }}">
                            {% endif %}
                        {% else %}
                            {% set first_media = p.media[0] if p.media else None %}
                            {% if first_media %}
                                {% if first_media.endswith(('.mp4', '.webm', '.mov')) %}
                                <video muted preload="metadata" playsinline>
                                    <source src="{{ url_for('static', filename='uploads/' ~ first_media) }}">
                                </video>
                                {% else %}
                                <img loading="lazy" src="{{ url_for('static', filename='uploads/' ~ first_media) }}" alt="{{ p.title }}">
                                {% endif %}
                            {% else %}
                            <img loading="lazy" src="{{ url_for('static', filename='images/placeholder.jpg') }}" alt="{{ p.title }}">
                            {% endif %}
                        {% endif %}
                    {% else %}
                    <img loading="lazy" src="{{ url_for('static', filename='images/placeholder.jpg') }}" alt="{{ p.title }}">
                    {% endif %}
                    <span class="status-badge {{ 'sold' if p.status == 'sold' else 'available' }}">{{ 'Sold' if p.status == 'sold' else 'Available' }}</span>
                </div>

                <div class="property-content">
                    <h3>{{ p.title }}</h3>
                    <p class="property-location"><i class="fas fa-map-pin"></i> {{ p.location }}</p>
                    <p class="property-desc">{{ p.description[:110] if p.description else 'Prime verified property in a strategic growth location.' }}...</p>
                    <div class="property-meta">
                        <span>{{ p.area }}</span>
                        <strong>KSh {{ "{:,}".format((p.price or 0)|int) }}</strong>
                    </div>
                    <div class="property-actions">
                        <button class="card-btn ghost quick-view-btn" type="button" data-quick-view="{{ p._id }}">Quick View</button>
                        <a class="card-btn solid" href="/properties/{{ p._id }}">Details</a>
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>
    </section>
</div>

<div class="quick-view-modal" id="quickViewModal" aria-hidden="true">
    <div class="quick-view-panel">
        <button class="quick-close-btn" id="quickCloseBtn" type="button" aria-label="Close quick view">
            <i class="fas fa-times"></i>
        </button>
        <div id="quickViewContent"></div>
    </div>
</div>
{% endblock %}

{% block socket_script %}
<script defer src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
{% endblock %}

{% block extra_js %}
<script defer src="{{ url_for('static', filename='js/properties-modern.js') }}"></script>
{% endblock %}
