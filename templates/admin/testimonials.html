{% extends "admin/admin_base.html" %}
{% block title %}Testimonials{% endblock %}

{% block content %}

<!-- =========================
   PAGE HEADER
========================= -->
<div class="page-header">
    <div>
        <h1>Testimonials Management</h1>
        <p>Manage client reviews and testimonials</p>
    </div>
    <button class="btn-primary" onclick="openAddModal()">
        + Add New Testimonial
    </button>
</div>

<!-- =========================
   FILTERS
========================= -->
<div class="filters">
    <input
        type="text"
        id="search"
        placeholder="Search testimonials..."
        autocomplete="off"
        onkeyup="filterTestimonials()"
    >

    <select id="statusFilter" onchange="filterTestimonials()">
        <option value="">All Status</option>
        <option value="published">Published</option>
        <option value="draft">Draft</option>
    </select>
</div>

<!-- =========================
   TESTIMONIALS GRID
========================= -->
<div class="testimonial-grid" id="testimonialGrid">
    <p style="text-align:center; padding:40px; color:#999;">Loading testimonials...</p>
</div>

<!-- =========================
   VIEW TESTIMONIAL MODAL
========================= -->
<div class="modal" id="viewModal" style="display: none;">
    <div class="modal-content" style="background: #ffffff; max-width: 600px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <div class="modal-header" style="border-bottom: 1px solid #e5e7eb; padding: 20px;">
            <h3 style="margin: 0; color: #0a3c28;">View Testimonial</h3>
            <span class="modal-close" onclick="closeViewModal()" style="cursor: pointer; font-size: 24px; color: #999;">√ó</span>
        </div>
        <div class="modal-body" id="viewContent" style="padding: 25px; background: #ffffff; max-height: 70vh; overflow-y: auto;">
        </div>
        <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 15px 20px; background: #f9fafb;">
            <button class="btn-secondary" onclick="closeViewModal()" style="background: #ffffff; border: 1px solid #d1d5db; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">Close</button>
        </div>
    </div>
</div>

<!-- =========================
   ADD/EDIT TESTIMONIAL MODAL
========================= -->
<div class="modal" id="testimonialModal" style="display: none;">
    <div class="modal-content">

        <div class="modal-header">
            <h3 id="modalTitle">Add Testimonial</h3>
            <span class="modal-close" onclick="closeModal()">√ó</span>
        </div>

        <div class="modal-body">
            <input type="hidden" id="testimonialId">
            
            <input
                type="text"
                id="name"
                placeholder="Client Name"
                autocomplete="off"
                required
            >

            <input
                type="text"
                id="location"
                placeholder="Location"
                autocomplete="off"
                required
            >

            <input
                type="text"
                id="property"
                placeholder="Property (optional)"
                autocomplete="off"
            >

            <select id="rating" required>
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 Stars)</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 Stars)</option>
                <option value="3">‚≠ê‚≠ê‚≠ê (3 Stars)</option>
                <option value="2">‚≠ê‚≠ê (2 Stars)</option>
                <option value="1">‚≠ê (1 Star)</option>
            </select>

            <select id="status">
                <option value="draft">Draft</option>
                <option value="published">Published</option>
            </select>

            <textarea
                id="message"
                placeholder="Testimonial message"
                rows="4"
                required
            ></textarea>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" onclick="saveTestimonial()">Save</button>
        </div>

    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let allTestimonials = [];
let editingId = null;

// Load testimonials on page load
function loadTestimonials() {
    fetch('/api/testimonials/admin')
        .then(response => response.json())
        .then(data => {
            allTestimonials = data;
            renderTestimonials();
        })
        .catch(err => {
            console.error('Failed to load testimonials:', err);
            document.getElementById('testimonialGrid').innerHTML = '<p style="text-align:center; color:#999;">Failed to load testimonials</p>';
        });
}

function renderTestimonials() {
    const search = document.getElementById('search').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    const filtered = allTestimonials.filter(t => {
        const matchesSearch = t.name.toLowerCase().includes(search) || 
                            (t.location || '').toLowerCase().includes(search) ||
                            (t.testimonial || '').toLowerCase().includes(search);
        const matchesStatus = !statusFilter || (t.status || 'draft') === statusFilter;
        return matchesSearch && matchesStatus;
    });
    
    const grid = document.getElementById('testimonialGrid');
    
    if (filtered.length === 0) {
        grid.innerHTML = '<p style="text-align:center; padding:40px; color:#999;">No testimonials found</p>';
        return;
    }
    
    grid.innerHTML = filtered.map(t => `
        <div class="testimonial-card-admin">
            <div class="testimonial-header">
                <div>
                    <h4>${escapeHTML(t.name)}</h4>
                    <p style="font-size:12px; color:#999;">${escapeHTML(t.location)}</p>
                </div>
                <span class="status-badge ${(t.status || 'draft').toLowerCase()}">${t.status || 'Draft'}</span>
            </div>
            
            <div class="stars">${Array(parseInt(t.rating || 5)).fill('‚≠ê').join('')}</div>
            
            <p style="color:#555; font-style:italic; margin:10px 0;">"${escapeHTML((t.testimonial || '').substring(0, 100))}..."</p>
            
            <div class="testimonial-actions">
                <button class="btn-sm view-btn" onclick="viewTestimonial('${t._id}')">üëÅÔ∏è View</button>
                <button class="btn-sm edit-btn" onclick="editTestimonial('${t._id}')">‚úèÔ∏è Edit</button>
                <button class="btn-sm delete-btn" onclick="deleteTestimonial('${t._id}')">üóëÔ∏è Delete</button>
            </div>
        </div>
    `).join('');
}

function filterTestimonials() {
    renderTestimonials();
}

function openAddModal() {
    editingId = null;
    document.getElementById('modalTitle').textContent = 'Add Testimonial';
    document.getElementById('testimonialId').value = '';
    document.getElementById('name').value = '';
    document.getElementById('location').value = '';
    document.getElementById('property').value = '';
    document.getElementById('rating').value = '5';
    document.getElementById('status').value = 'draft';
    document.getElementById('message').value = '';
    document.getElementById('testimonialModal').style.display = 'flex';
}

function editTestimonial(id) {
    const t = allTestimonials.find(x => x._id === id);
    if (!t) return;
    
    editingId = id;
    document.getElementById('modalTitle').textContent = 'Edit Testimonial';
    document.getElementById('testimonialId').value = id;
    document.getElementById('name').value = t.name || '';
    document.getElementById('location').value = t.location || '';
    document.getElementById('property').value = t.property || '';
    document.getElementById('rating').value = t.rating || 5;
    document.getElementById('status').value = t.status || 'draft';
    document.getElementById('message').value = t.testimonial || '';
    document.getElementById('testimonialModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('testimonialModal').style.display = 'none';
    editingId = null;
}

function viewTestimonial(id) {
    const t = allTestimonials.find(x => x._id === id);
    if (!t) return;
    
    const viewContent = document.getElementById('viewContent');
    viewContent.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h3 style="color: #0a3c28; margin: 0 0 10px 0;">${escapeHTML(t.name)}</h3>
            <p style="color: #374151; margin: 0 0 15px 0;"><strong>Location:</strong> ${escapeHTML(t.location)}</p>
            ${t.property ? `<p style="color: #374151; margin: 0 0 15px 0;"><strong>Property:</strong> ${escapeHTML(t.property)}</p>` : ''}
            <p style="color: #374151; margin: 0 0 15px 0;"><strong>Rating:</strong> ${Array(parseInt(t.rating || 5)).fill('‚≠ê').join('')} (${t.rating || 5}/5)</p>
            <p style="color: #374151; margin: 0 0 15px 0;"><strong>Status:</strong> <span class="status-badge ${(t.status || 'draft').toLowerCase()}">${t.status || 'Draft'}</span></p>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 15px 0;">
            <p style="color: #1f2937; line-height: 1.6; font-style: italic; font-size: 1.05rem;">"${escapeHTML(t.testimonial)}"</p>
        </div>
    `;
    document.getElementById('viewModal').style.display = 'flex';
}

function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
}

function closeModal() {
    document.getElementById('testimonialModal').style.display = 'none';
    editingId = null;
}

function saveTestimonial() {
    const data = {
        name: document.getElementById('name').value.trim(),
        location: document.getElementById('location').value.trim(),
        property: document.getElementById('property').value.trim(),
        rating: parseInt(document.getElementById('rating').value),
        status: document.getElementById('status').value,
        testimonial: document.getElementById('message').value.trim()
    };
    
    if (!data.name || !data.location || !data.testimonial) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    const url = editingId 
        ? `/admin/testimonials/update/${editingId}`
        : '/admin/testimonials/add';
    
    const method = 'POST';
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.message === "success" || !data.error) {
            closeModal();
            loadTestimonials();
            showToast(editingId ? 'Testimonial updated successfully!' : 'Testimonial added successfully!', 'success');
        } else {
            showToast('Error: ' + (data.error || 'Failed to save testimonial'), 'error');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showToast('Error saving testimonial: ' + err.message, 'error');
    });
}

function deleteTestimonial(id) {
    if (!confirm('Are you sure you want to delete this testimonial?')) return;
    
    fetch(`/admin/testimonials/delete/${id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTestimonials();
                showToast('Testimonial deleted successfully!', 'success');
            } else {
                showToast('Error: ' + (data.error || 'Failed to delete'), 'error');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            showToast('Error deleting testimonial', 'error');
        });
}

function showToast(message, type = 'success') {
    const div = document.createElement('div');
    const bgColor = type === 'success' ? '#10b981' : '#ef4444';
    const icon = type === 'success' ? '‚úì' : '‚úó';
    div.style.cssText = `position:fixed;top:20px;right:20px;background:${bgColor};color:white;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;animation:slideIn 0.3s ease-out;font-weight:600;`;
    div.textContent = icon + ' ' + message;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

function escapeHTML(str) {
    return (str || '').replace(/[&<>"']/g, c => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
    ));
}

// Load on page load
loadTestimonials();

// Refresh every 5 seconds for real-time updates
setInterval(loadTestimonials, 5000);

// Add slideIn animation
const style = document.createElement('style');
style.textContent = '@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }';
document.head.appendChild(style);
</script>

<style>
.testimonial-card-admin {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.2s;
}

.testimonial-card-admin:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    border-color: #d1d5db;
}

.testimonial-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.testimonial-header h4 {
    margin: 0;
    color: #0a3c28;
    font-size: 14px;
}

.testimonial-header p {
    margin: 0;
}

.stars {
    font-size: 16px;
    margin-bottom: 10px;
}

.testimonial-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.btn-sm {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
}

.edit-btn {
    background: #e6f4ff;
    color: #0b63c8;
}

.edit-btn:hover {
    background: #bae6fd;
}

.view-btn {
    background: #dbeafe;
    color: #1e40af;
}

.view-btn:hover {
    background: #bfdbfe;
}

.delete-btn {
    background: #fee2e2;
    color: #b91c1c;
}

.delete-btn:hover {
    background: #fecaca;
}

.modal-content {
    width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-body input,
.modal-body select,
.modal-body textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-family: inherit;
}

.modal-body select,
.modal-body textarea {
    font-size: 14px;
}

.modal-footer {
    display: flex;
    gap: 10px;
    padding: 15px;
    border-top: 1px solid #e5e7eb;
}

.modal-footer button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
}

.btn-primary {
    background: #0a3c28;
    color: white;
}
</style>

{% endblock %}
