{% extends "admin/admin_base.html" %}

{% block title %}Edit Property{% endblock %}

{% block content %}

<div class="add-property-container">

    <div class="modal-content-header">
        <a href="/admin/properties" class="back-arrow">←</a>
        <div>
            <h2>Edit Property</h2>
            <p>Update property details</p>
        </div>
    </div>

    <form method="POST"
          action="{{ url_for('edit_property', property_id=property._id) }}"
          enctype="multipart/form-data"
          class="property-form">

        <div class="form-section">
            <label>Property Title *</label>
            <input type="text" name="title" value="{{ property.title }}" required placeholder="Enter property title">

            <label>Location *</label>
            <input type="text" name="location" value="{{ property.location }}" required placeholder="Enter location">

            <label>County/State</label>
            <input type="text" name="county" value="{{ property.county or '' }}" placeholder="e.g. Mwingi, Kitui">

            <label>Property Type *</label>
            <input type="text" name="property_type" value="{{ property.property_type or '' }}" required placeholder="e.g. Land, House, Commercial">
        </div>

        <div class="form-section form-row">
            <div>
                <label>Price (KES) *</label>
                <input type="number" name="price" value="{{ property.price }}" required placeholder="e.g., 5000000">
            </div>

            <div>
                <label>Area *</label>
                <input type="text" name="area" value="{{ property.area }}" required placeholder="e.g., 2.5 acres or 50 by 100">
            </div>
        </div>

        <div class="form-section">
            <label>Description *</label>
            <textarea name="description" class="rich-text" rows="5" required placeholder="Describe the property in detail...">{{ property.description }}</textarea>

            <label>Key Features (one per line)</label>
            <textarea name="features" class="rich-text" rows="4" placeholder="e.g., Gated community&#10;24/7 Security&#10;Water access">{{ property.features }}</textarea>
        </div>

        <div class="form-section">
            <label>Contact Name *</label>
            <input type="text" name="contact_name" value="{{ property.contact_name or '' }}" required placeholder="e.g. John Doe">

            <label>Contact Email *</label>
            <input type="text" name="contact_email" value="{{ property.contact_email or '' }}" required placeholder="e.g. contact@landvista.co.ke or inquiries.landvista.com">

            <label>Contact Phone *</label>
            <input type="text" name="contact_phone" value="{{ property.contact_phone or '' }}" required placeholder="e.g. +254 700 000000">
        </div>

        <div class="form-section">
            <label>Update Media (Images or Videos) - Select multiple to add multiple files</label>
            <input type="file" name="media" accept="image/*,video/*" multiple>
            {% if property.media %}
                <div style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                    <p style="margin: 0 0 10px 0; font-weight: 600;">Current Media:</p>
                    {% if property.media is string %}
                        <div style="position: relative; display: inline-block; margin-right: 10px;">
                            {% if property.media.endswith(('.mp4', '.webm', '.mov')) %}
                                <video width="200" height="150" controls style="border-radius: 4px;">
                                    <source src="{{ url_for('static', filename='uploads/' ~ property.media) }}">
                                </video>
                            {% else %}
                                <img src="{{ url_for('static', filename='uploads/' ~ property.media) }}" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                            {% endif %}
                            <button type="button" class="delete-media-btn" onclick="deleteImage('{{ property._id }}', '{{ property.media }}', this)" 
                                    style="position: absolute; top: 5px; right: 5px; background: #dc2626; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">
                                Delete
                            </button>
                        </div>
                    {% else %}
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            {% for media_file in property.media %}
                                <div style="position: relative; display: inline-block;">
                                    {% if media_file.endswith(('.mp4', '.webm', '.mov')) %}
                                        <video width="150" height="120" controls style="border-radius: 4px;">
                                            <source src="{{ url_for('static', filename='uploads/' ~ media_file) }}">
                                        </video>
                                    {% else %}
                                        <img src="{{ url_for('static', filename='uploads/' ~ media_file) }}" style="max-width: 150px; max-height: 120px; border-radius: 4px;">
                                    {% endif %}
                                    <button type="button" class="delete-media-btn" onclick="deleteImage('{{ property._id }}', '{{ media_file }}', this)" 
                                            style="position: absolute; top: 5px; right: 5px; background: #dc2626; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">
                                        Delete
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small style="color: #6b7280; margin-top: 8px; display: block;">Leave file empty to keep existing media</small>
                </div>
            {% else %}
                <small style="color: #6b7280; margin-top: 8px; display: block;">No media currently attached</small>
            {% endif %}
        </div>

        <div class="form-actions">
            <a href="/admin/properties" class="btn-cancel">
                Cancel
            </a>

            <button type="submit" class="btn-save">
                Save Changes
            </button>
        </div>

    </form>

</div>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/properties_add.css') }}">
{% endblock %}

{% block scripts %}
<script>
function deleteImage(propertyId, imageName, button) {
    console.log('deleteImage called with:', { propertyId, imageName });
    
    if (!confirm('Are you sure you want to delete this image?')) {
        return;
    }
    
    // Disable button and show loading state
    button.disabled = true;
    const originalText = button.textContent;
    button.textContent = 'Deleting...';
    
    // URL encode the image name to handle special characters
    const encodedImageName = encodeURIComponent(imageName);
    const url = `/admin/properties/${propertyId}/delete-image/${encodedImageName}`;
    
    console.log('Sending DELETE request to:', url);
    
    // Send delete request (include credentials so session cookie is sent)
    fetch(url, {
        method: 'POST',
        credentials: 'same-origin'
    })
    .then(async response => {
        console.log('Response status:', response.status, 'redirected:', response.redirected, 'url:', response.url);
        // If server redirected to login, treat as unauthorized
        if (response.redirected && response.url && response.url.includes('/admin/login')) {
            alert('Session expired — please log in again as admin');
            window.location.href = '/admin/login';
            throw new Error('Not authenticated');
        }
        if (!response.ok) {
            // Try to read JSON error if available
            let text = await response.text();
            try { var parsed = JSON.parse(text); } catch(e){ parsed = null }
            const err = parsed && parsed.error ? parsed.error : `HTTP ${response.status}`;
            throw new Error(err);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Find and remove the parent container
            const container = button.closest('div[style*="position"]') 
                            || button.closest('div')
                            || button.parentElement;
            
            console.log('Removing container:', container);
            container.remove();
            alert('Image deleted successfully');
            
            // Reload page to refresh media display
            setTimeout(() => {
                location.reload();
            }, 800);
        } else {
            alert('Error deleting image: ' + (data.error || 'Unknown error'));
            button.disabled = false;
            button.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('Error deleting image: ' + error.message);
        button.disabled = false;
        button.textContent = originalText;
        // Fallback: submit a standard form to the server (ensures cookies/session are sent)
        try {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/properties/${propertyId}/delete-image-form`;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'image_name';
            input.value = imageName;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        } catch (e) {
            console.error('Fallback form submit failed:', e);
        }
    });
}
</script>
{% endblock %}
