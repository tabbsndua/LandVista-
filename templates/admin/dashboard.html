{% extends "admin/admin_base.html" %}  

{% block title %}Dashboard | Admin{% endblock %}

{% block topbar %}
<div class="topbar">
    <div class="dashboard-header">
        <h1>üìä Dashboard</h1>
        <p class="live-indicator" id="liveStatus">
            <i class="fa-solid fa-circle" style="color: #10b981; margin-right: 6px;"></i>
            <span>Live Data ‚Ä¢ Updating every 3 seconds</span>
        </p>
    </div>
    <div class="admin-profile">
        <i class="fa-solid fa-user-circle"></i>
        <span>Admin</span>
    </div>
</div>
{% endblock %}

{% block content %}

<!-- ================= STAT CARDS ================= -->
<div class="dashboard-intro">
    <p>Welcome back! Here's a real-time overview of your property business.</p>
</div>

<div class="stats-grid">

    <div class="stat-card stat-blue">
        <div class="stat-header">
            <div class="stat-icon">
                <i class="fa-solid fa-building"></i>
            </div>
            <span class="stat-label">Total Properties</span>
        </div>
        <div class="stat-value" id="total-properties">{{ total_properties }}</div>
        <p class="stat-subtext">Across all listings</p>
    </div>

    <div class="stat-card stat-green">
        <div class="stat-header">
            <div class="stat-icon">
                <i class="fa-solid fa-users"></i>
            </div>
            <span class="stat-label">Active Clients</span>
        </div>
        <div class="stat-value" id="active-clients">{{ active_clients }}</div>
        <p class="stat-subtext">Registered clients</p>
    </div>

    <div class="stat-card stat-purple">
        <div class="stat-header">
            <div class="stat-icon">
                <i class="fa-solid fa-star"></i>
            </div>
            <span class="stat-label">Testimonials</span>
        </div>
        <div class="stat-value" id="total-testimonials">{{ total_testimonials }}</div>
        <p class="stat-subtext">Client reviews</p>
    </div>

    <div class="stat-card stat-gold">
        <div class="stat-header">
            <div class="stat-icon">
                <i class="fa-solid fa-naira-sign"></i>
            </div>
            <span class="stat-label">Total Sales</span>
        </div>
        <div class="stat-value">KSh <span id="total-sales">{{ total_sales }}</span></div>
        <p class="stat-subtext">Revenue this quarter</p>
    </div>

</div>

<!-- ================= RECENT PROPERTIES ================= -->
<div class="dashboard-section">
    <div class="section-header">
        <h2 class="section-title">üè† Recent Properties</h2>
        <a href="/admin/properties" class="view-all-link">View All ‚Üí</a>
    </div>
    <div class="recent-list grid-3">
        {% for p in recent_properties %}
        <div class="recent-card">
            <div class="recent-info">
                <h3>{{ p.title }}</h3>
                <p class="text-muted">{{ p.location }}</p>
            </div>
            <div class="recent-meta">
                <strong class="price">KSh {{ "{:,}".format(p.price) }}</strong>
                <span class="status status-{{ p.status|lower }}">{{ p.status|upper }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ================= RECENT INQUIRIES ================= -->
<div class="dashboard-section">
    <div class="section-header">
        <h2 class="section-title">üí¨ Recent Inquiries</h2>
        <a href="/admin/inquiries" class="view-all-link">View All ‚Üí</a>
    </div>
    <div class="recent-list" id="recent-inquiries-container">
        {% for i in recent_inquiries %}
        <div class="recent-card">
            <div class="recent-info">
                <h3>{{ i.name }}</h3>
                <p class="text-muted">{{ i.email }} ‚Ä¢ {{ i.phone }}</p>
                <p class="interested">Interested in: <strong>{{ i.property or 'N/A' }}</strong></p>
            </div>
            <div class="recent-meta">
                <span class="inquiry-status">{{ i.status|upper }}</span>
                <span class="date">üìÖ {{ i.created_at }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ================= BUSINESS PERFORMANCE ================= -->
<div class="dashboard-section">
    <h2 class="section-title">üìà Business Performance</h2>
    <div class="performance-grid">

        <div class="perf-card perf-sales">
            <div class="perf-icon"><i class="fa-solid fa-naira-sign"></i></div>
            <div class="perf-content">
                <p class="perf-label">Total Sales</p>
                <h3 class="perf-value">KSh {{ total_sales }}</h3>
                <span class="perf-meta">This quarter</span>
            </div>
        </div>

        <div class="perf-card perf-views">
            <div class="perf-icon"><i class="fa-solid fa-eye"></i></div>
            <div class="perf-content">
                <p class="perf-label">Page Views</p>
                <h3 class="perf-value" id="page-views">{{ page_views }}</h3>
                <span class="perf-meta">Last 30 days</span>
            </div>
        </div>

        <div class="perf-card perf-sold">
            <div class="perf-icon"><i class="fa-solid fa-check-circle"></i></div>
            <div class="perf-content">
                <p class="perf-label">Properties Sold</p>
                <h3 class="perf-value" id="properties-sold">{{ properties_sold }}</h3>
                <span class="perf-meta">This month</span>
            </div>
        </div>

    </div>
</div>

<!-- ================= LATEST NEWS & ARTICLES ================= -->
<div class="dashboard-section">
    <div class="section-header">
        <h2 class="section-title">üì∞ Latest News & Articles</h2>
        <a href="/admin/news" class="view-all-link">View All ‚Üí</a>
    </div>
    <div class="recent-list grid-3">
        {% if latest_news %}
            {% for article in latest_news %}
            <div class="recent-card">
                <div class="recent-info">
                    <h3>{{ article.title }}</h3>
                    <p class="text-muted">{{ article.author }} ‚Ä¢ {{ article.date }}</p>
                    <p class="interested">Category: <strong>{{ article.category }}</strong></p>
                </div>
                <div class="recent-meta">
                    <span class="status status-{{ article.status|lower }}">{{ article.status|upper }}</span>
                    <span class="date">‚è±Ô∏è {{ article.readTime }} min</span>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="recent-card" style="text-align: center; color: #6b7280; padding: 20px;">
                <p>No articles published yet</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- ================= LATEST LEGAL GUIDES ================= -->
<div class="dashboard-section">
    <div class="section-header">
        <h2 class="section-title">‚öñÔ∏è Latest Legal Guides</h2>
        <a href="/admin/legal-guides" class="view-all-link">View All ‚Üí</a>
    </div>
    <div class="recent-list">
        {% if latest_guides %}
            {% for guide in latest_guides %}
            <div class="recent-card">
                <div class="recent-info">
                    <h3>{{ guide.title }}</h3>
                    <p class="text-muted">{{ guide.author }} ‚Ä¢ {{ guide.date }}</p>
                    <p class="interested">Category: <strong>{{ guide.category }}</strong></p>
                </div>
                <div class="recent-meta">
                    <span class="status status-{{ guide.status|lower }}">{{ guide.status|upper }}</span>
                    <span class="date">‚è±Ô∏è {{ guide.readTime }} min</span>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="recent-card" style="text-align: center; color: #6b7280; padding: 20px;">
                <p>No guides published yet</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
function refreshDashboard() {
    fetch("/admin/dashboard-data")
        .then(response => response.json())
        .then(data => {
            // Animate stat card updates
            animateUpdate("total-properties", data.total_properties);
            animateUpdate("active-clients", data.active_clients);
            animateUpdate("total-testimonials", data.total_testimonials);
            animateUpdate("total-sales", data.total_sales);
            animateUpdate("page-views", data.page_views);
            animateUpdate("properties-sold", data.properties_sold);

            // Update live status
            updateLiveStatus();

            // Update recent inquiries in real-time with animation
            if (data.recent_inquiries && data.recent_inquiries.length > 0) {
                const inquiriesContainer = document.getElementById("recent-inquiries-container");
                const newHTML = data.recent_inquiries.map(i => `
                    <div class="recent-card dashboard-update">
                        <div class="recent-info">
                            <h3>${escapeHTML(i.name)}</h3>
                            <p class="text-muted">${escapeHTML(i.email)} ‚Ä¢ ${escapeHTML(i.phone || 'N/A')}</p>
                            <p class="interested">Interested in: <strong>${escapeHTML(i.property || 'N/A')}</strong></p>
                        </div>
                        <div class="recent-meta">
                            <span class="inquiry-status">${(i.status || 'new').toUpperCase()}</span>
                            <span class="date">üìÖ ${escapeHTML(i.created_at)}</span>
                        </div>
                    </div>
                `).join('');
                
                if (inquiriesContainer.innerHTML !== newHTML) {
                    inquiriesContainer.innerHTML = newHTML;
                }
            }
        })
        .catch(err => {
            console.error("Dashboard update error:", err);
            updateLiveStatus(true);
        });
}

function animateUpdate(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const oldValue = element.innerText;
    if (oldValue !== String(newValue)) {
        element.classList.add('updating');
        element.innerText = newValue;
        setTimeout(() => element.classList.remove('updating'), 600);
    }
}

function updateLiveStatus(isError = false) {
    const status = document.getElementById("liveStatus");
    if (isError) {
        status.style.color = "#ef4444";
        status.innerHTML = '<i class="fa-solid fa-circle" style="color: #ef4444; margin-right: 6px;"></i><span>Connection lost ‚Ä¢ Retrying...</span>';
    } else {
        status.style.color = "#10b981";
        status.innerHTML = '<i class="fa-solid fa-circle" style="color: #10b981; margin-right: 6px;"></i><span>Live Data ‚Ä¢ Updating every 3 seconds</span>';
    }
}

function escapeHTML(str) {
    return (str || '').replace(/[&<>"']/g, c => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
    ));
}

// Initial load
refreshDashboard();

// Refresh every 3 seconds for real-time updates
setInterval(refreshDashboard, 3000);
</script>

{% endblock %}
