{% extends "base.html" %}

{% block title %}{{ property.title }} | LandVista{% endblock %}
{% block meta_description %}{{ (property.description or ('Explore ' ~ property.title ~ ' in ' ~ property.location ~ ' with verified due diligence support and flexible acquisition guidance.'))[:155] }}{% endblock %}
{% block meta_keywords %}{{ property.title }}, {{ property.location }}, land for sale kenya, verified property listing{% endblock %}
{% block body_class %}property-modern-body{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/property-details-modern.css') }}">
{% endblock %}

{% block content %}
{% set media_list = [] %}
{% if property.media is defined and property.media %}
    {% if property.media is string %}
        {% set media_list = [property.media] %}
    {% else %}
        {% set media_list = property.media %}
    {% endif %}
{% endif %}

{% set feature_list = [] %}
{% if property.features is defined and property.features %}
    {% if property.features is string %}
        {% set feature_list = property.features.split('\n') %}
    {% else %}
        {% set feature_list = property.features %}
    {% endif %}
{% endif %}

<section class="pd-page-wrap">
    <section class="pd-hero" data-reveal>
        <div class="pd-hero-copy">
            <nav class="pd-breadcrumb" aria-label="Breadcrumb">
                <a href="/home">Home</a>
                <span>/</span>
                <a href="/properties">Properties</a>
                <span>/</span>
                <strong>{{ property.title }}</strong>
            </nav>
            <p class="pd-kicker">Verified Land Opportunity</p>
            <h1>{{ property.title }}</h1>
            <p class="pd-location"><i class="fas fa-location-dot"></i> {{ property.location }}{% if property.county %}, {{ property.county }}{% endif %}, Kenya</p>
            <div class="pd-hero-meta">
                <span><i class="fas fa-ruler-combined"></i> {{ property.area if property.area else 'Flexible plot sizes available' }}</span>
                <span><i class="fas fa-circle-check"></i> {{ 'Sold' if (property.status or '')|lower == 'sold' else 'Available' }}</span>
                <span><i class="fas fa-shield-halved"></i> Due diligence ready</span>
            </div>
        </div>
        <div class="pd-hero-price">
            <p>Investment Value</p>
            <h2>KSh {{ '{:,}'.format(property.price|int) if property.price else '0' }}</h2>
            <small>Guidance, documentation, and onboarding support included</small>
        </div>
    </section>

    <section class="pd-top-layout" data-reveal>
        <div class="pd-gallery-panel">
            <div class="pd-stage" id="pdStage" role="region" aria-live="polite">
                {% if media_list and media_list[0] %}
                    {% set first_media = media_list[0] %}
                    {% if first_media.endswith(('.mp4', '.webm', '.mov')) %}
                        <video controls preload="metadata">
                            <source src="{{ url_for('static', filename='uploads/' ~ first_media) }}">
                        </video>
                    {% else %}
                        <img id="pdMainMedia" src="{{ url_for('static', filename='uploads/' ~ first_media) }}" alt="{{ property.title }}" loading="eager">
                    {% endif %}
                {% else %}
                    <div class="pd-placeholder-media">
                        <i class="fas fa-image"></i>
                        <p>Media preview will appear here</p>
                    </div>
                {% endif %}
                <button class="pd-nav prev" id="pdPrev" type="button" aria-label="Previous media"><i class="fas fa-chevron-left"></i></button>
                <button class="pd-nav next" id="pdNext" type="button" aria-label="Next media"><i class="fas fa-chevron-right"></i></button>
                <button class="pd-expand" id="pdExpand" type="button" aria-label="Open media viewer"><i class="fas fa-expand"></i></button>
            </div>

            <div class="pd-thumbs" id="pdThumbs">
                {% if media_list %}
                    {% for media in media_list %}
                    <button type="button" class="pd-thumb {% if loop.first %}active{% endif %}" data-media="{{ media }}" data-index="{{ loop.index0 }}">
                        {% if media.endswith(('.mp4', '.webm', '.mov')) %}
                            <span class="pd-video-thumb"><i class="fas fa-play"></i></span>
                        {% else %}
                            <img src="{{ url_for('static', filename='uploads/' ~ media) }}" alt="Media {{ loop.index }}" loading="lazy">
                        {% endif %}
                    </button>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="pd-badges-row">
                <span><i class="fas fa-check"></i> Verified title workflow</span>
                <span><i class="fas fa-map"></i> Strategic growth corridor</span>
                <span><i class="fas fa-phone"></i> Dedicated advisory support</span>
            </div>
        </div>

        <aside class="pd-sticky-panel">
            <article class="pd-contact-card">
                <div class="pd-contact-head">
                    <h3>Talk to a Property Advisor</h3>
                    <p>Get exact payment options, legal requirements, and next steps for this property.</p>
                </div>

                <form id="pdQuickInquiryForm" class="pd-form-grid">
                    <input type="text" name="name" placeholder="Full name" required>
                    <input type="tel" name="phone" placeholder="Phone number" required>
                    <input type="email" name="email" placeholder="Email address" required>
                    <select name="inquiry_type" required>
                        <option value="">Inquiry type</option>
                        <option value="buyer">Buyer</option>
                        <option value="investor">Investor</option>
                        <option value="agent">Agent</option>
                    </select>
                    <textarea name="message" rows="4" required>I am interested in {{ property.title }}. Please share full details and process.</textarea>
                    <input type="hidden" name="property_id" value="{{ property._id }}">
                    <input type="hidden" name="property_title" value="{{ property.title }}">
                    <button type="submit" class="pd-btn-primary" id="pdInquirySubmit">Send Inquiry</button>
                </form>

                <div class="pd-quick-actions">
                    <button type="button" class="pd-btn-secondary" data-open-modal="pdVisitModal">Book Site Visit</button>
                    <a href="https://wa.me/254784666927?text=Hello%20I%20am%20interested%20in%20{{ property.title | replace(' ', '%20') }}%20at%20{{ property.location | replace(' ', '%20') }}" target="_blank" rel="noopener noreferrer" class="pd-btn-whatsapp">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </a>
                </div>

                <div class="pd-share-row">
                    <button type="button" id="pdCopyLinkBtn"><i class="fas fa-link"></i> Copy Link</button>
                    <button type="button" data-open-modal="pdInquiryModal"><i class="fas fa-file-lines"></i> Request Brochure</button>
                </div>
                <p class="pd-form-feedback" id="pdQuickInquiryFeedback"></p>
            </article>
        </aside>
    </section>

    <section class="pd-details-layout" data-reveal>
        <article class="pd-detail-card">
            <div class="pd-section-head">
                <h2>Property Overview</h2>
                <p>Detailed listing information to support confident decision-making.</p>
            </div>
            <div class="pd-overview-grid">
                <div>
                    <span>Location</span>
                    <strong>{{ property.location }}{% if property.county %}, {{ property.county }}{% endif %}</strong>
                </div>
                <div>
                    <span>Type</span>
                    <strong>Land</strong>
                </div>
                <div>
                    <span>Status</span>
                    <strong>{{ 'Sold' if (property.status or '')|lower == 'sold' else 'Available' }}</strong>
                </div>
                <div>
                    <span>Area</span>
                    <strong>{{ property.area if property.area else 'Flexible size options' }}</strong>
                </div>
                <div>
                    <span>Investment Value</span>
                    <strong>KSh {{ '{:,}'.format(property.price|int) if property.price else '0' }}</strong>
                </div>
                <div>
                    <span>Region</span>
                    <strong>{{ property.county if property.county else 'Kenya' }}</strong>
                </div>
            </div>
        </article>

        <article class="pd-detail-card">
            <div class="pd-section-head">
                <h2>Description</h2>
                <p>Key context around this property and value potential.</p>
            </div>
            <div class="pd-rich-copy">{{ property.description|safe if property.description else 'This listing is in a strategic area with strong long-term potential. Contact our advisory desk for full due diligence notes and installment options.' }}</div>

            <div class="pd-feature-block">
                <h3>Key Features</h3>
                <div class="pd-feature-grid">
                    {% if feature_list %}
                        {% for feature in feature_list %}
                            {% if feature and feature|trim %}
                            <div class="pd-feature-item"><i class="fas fa-check-circle"></i> {{ feature|trim }}</div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="pd-feature-item"><i class="fas fa-check-circle"></i> Verified ownership and transfer workflow</div>
                        <div class="pd-feature-item"><i class="fas fa-check-circle"></i> Structured advisory support from inquiry to purchase</div>
                        <div class="pd-feature-item"><i class="fas fa-check-circle"></i> Strategic location for long-term value growth</div>
                    {% endif %}
                </div>
            </div>
        </article>

        <article class="pd-detail-card pd-calc-card">
            <div class="pd-section-head">
                <h2>Investment Planner</h2>
                <p>Estimate down payment and projected installment requirements.</p>
            </div>
            <div class="pd-calc-controls">
                <label for="pdDownPaymentRange">Down payment (%)</label>
                <input type="range" id="pdDownPaymentRange" min="10" max="80" value="30" step="5">
                <p id="pdDownPaymentLabel">30%</p>
            </div>
            <div class="pd-calc-results">
                <div>
                    <span>Down payment</span>
                    <strong id="pdDownAmount">KSh 0</strong>
                </div>
                <div>
                    <span>Balance</span>
                    <strong id="pdBalanceAmount">KSh 0</strong>
                </div>
                <div>
                    <span>Estimated 12-month installment</span>
                    <strong id="pdInstallmentAmount">KSh 0</strong>
                </div>
            </div>
        </article>

        <article class="pd-detail-card">
            <div class="pd-section-head">
                <h2>Acquisition Roadmap</h2>
                <p>How LandVista supports your journey from inquiry to transfer.</p>
            </div>
            <div class="pd-process-grid">
                <div>
                    <span>Step 1</span>
                    <h4>Discovery Call</h4>
                    <p>Align budget, timeline, and property requirements.</p>
                </div>
                <div>
                    <span>Step 2</span>
                    <h4>Site Verification</h4>
                    <p>Physical visit with location orientation and suitability checks.</p>
                </div>
                <div>
                    <span>Step 3</span>
                    <h4>Documentation</h4>
                    <p>Title verification workflow and agreement preparation support.</p>
                </div>
                <div>
                    <span>Step 4</span>
                    <h4>Transfer and Handover</h4>
                    <p>Structured follow-through to close your transaction safely.</p>
                </div>
            </div>
        </article>

        <article class="pd-detail-card pd-faq-card">
            <div class="pd-section-head">
                <h2>Frequently Asked Questions</h2>
                <p>Common buyer and investor questions on this listing.</p>
            </div>
            <div class="pd-accordion" id="pdFaqAccordion">
                <button type="button" class="pd-accordion-item active">
                    <span>Is this property legally verified?</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="pd-accordion-panel" style="display:block;">
                    <p>LandVista follows a verification workflow before publishing listings. Request detailed due diligence notes through the inquiry form for this property.</p>
                </div>

                <button type="button" class="pd-accordion-item">
                    <span>Can I buy through installments?</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="pd-accordion-panel">
                    <p>Installment structures depend on project terms. Our advisors will provide available payment plans after your inquiry.</p>
                </div>

                <button type="button" class="pd-accordion-item">
                    <span>How soon can a site visit be scheduled?</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="pd-accordion-panel">
                    <p>Most visits are coordinated within 24-72 hours depending on your preferred date and transport plan.</p>
                </div>
            </div>
        </article>
    </section>

    <section class="pd-similar-section" data-reveal>
        <div class="pd-section-head">
            <h2>Similar Opportunities</h2>
            <p>Explore related listings in comparable growth zones.</p>
        </div>
        <div class="pd-similar-grid" id="pdSimilarGrid">
            <p class="pd-loading">Loading related properties...</p>
        </div>
    </section>
</section>

<div class="pd-modal" id="pdVisitModal" aria-hidden="true">
    <div class="pd-modal-panel">
        <button type="button" class="pd-modal-close" data-close-modal="pdVisitModal" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
        <h3>Book a Site Visit</h3>
        <p>Schedule a guided site orientation for {{ property.title }}.</p>
        <form id="pdVisitForm" class="pd-form-grid">
            <input type="text" name="name" placeholder="Full name" required>
            <input type="tel" name="phone" placeholder="Phone number" required>
            <input type="email" name="email" placeholder="Email address" required>
            <input type="date" name="visit_date" required>
            <textarea name="notes" rows="4" placeholder="Preferred time and specific requests"></textarea>
            <input type="hidden" name="property_id" value="{{ property._id }}">
            <input type="hidden" name="property_title" value="{{ property.title }}">
            <button type="submit" class="pd-btn-primary" id="pdVisitSubmit">Confirm Visit Request</button>
        </form>
        <p class="pd-form-feedback" id="pdVisitFeedback"></p>
    </div>
</div>

<div class="pd-modal" id="pdInquiryModal" aria-hidden="true">
    <div class="pd-modal-panel">
        <button type="button" class="pd-modal-close" data-close-modal="pdInquiryModal" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
        <h3>Request Brochure and Documentation Guide</h3>
        <p>Share your details and receive the listing profile with next-step guidance.</p>
        <form id="pdBrochureForm" class="pd-form-grid">
            <input type="text" name="name" placeholder="Full name" required>
            <input type="email" name="email" placeholder="Email address" required>
            <input type="tel" name="phone" placeholder="Phone number" required>
            <textarea name="message" rows="4" required>Please share brochure and documentation process for {{ property.title }}.</textarea>
            <input type="hidden" name="inquiry_type" value="buyer">
            <input type="hidden" name="property_id" value="{{ property._id }}">
            <input type="hidden" name="property_title" value="{{ property.title }}">
            <button type="submit" class="pd-btn-primary" id="pdBrochureSubmit">Send Request</button>
        </form>
        <p class="pd-form-feedback" id="pdBrochureFeedback"></p>
    </div>
</div>

<div class="pd-modal pd-media-modal" id="pdMediaModal" aria-hidden="true">
    <div class="pd-media-modal-panel">
        <button type="button" class="pd-modal-close" data-close-modal="pdMediaModal" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
        <div id="pdMediaModalContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
window.propertyDetailData = {
    id: "{{ property._id }}",
    title: {{ (property.title or '')|tojson }},
    location: {{ (property.location or '')|tojson }},
    county: {{ (property.county or '')|tojson }},
    price: {{ property.price if property.price else 0 }}
};
</script>
<script defer src="{{ url_for('static', filename='js/property-details-modern.js') }}"></script>
{% endblock %}
